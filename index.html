<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>多二维码扫描（多码高亮）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f4f6f9;
    text-align: center;
    padding: 20px;
  }
  h2 { color: #333; }
  #controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; }
  input { padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; width: 220px; }
  button { background: #007bff; color: #fff; border: none; padding: 10px 18px; border-radius: 8px; font-size: 16px; cursor: pointer; }
  button:hover { background: #0056b3; }
  #container { position: relative; display: inline-block; }
  #video { width: 100%; max-width: 600px; border-radius: 12px; background: #000; }
  #overlay { position: absolute; top: 0; left: 0; width: 100%; max-width: 600px; border-radius: 12px; }
  #output { margin-top: 15px; background: #fff; padding: 10px; border-radius: 8px; display: inline-block; text-align: left; max-width: 600px; word-break: break-word; }
</style>
</head>
<body>
<h2>多二维码扫描（多码高亮）</h2>
<div id="controls">
  <input type="text" id="keyword" placeholder="输入关键字过滤（可选）" />
  <button id="startBtn">Start Scan</button>
</div>

<div id="container">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="overlay"></canvas>
</div>

<div id="output"><b>识别结果：</b><br><span id="resultArea">暂无</span></div>

<!-- 引入 jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const resultArea = document.getElementById('resultArea');
const keywordInput = document.getElementById('keyword');
const startBtn = document.getElementById('startBtn');

let foundCodes = new Set();
let scanning = false;
let videoStream;

startBtn.addEventListener('click', async () => {
  if (scanning) return;
  scanning = true;
  foundCodes.clear();
  resultArea.innerHTML = "正在启动摄像头...";

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } });
    video.srcObject = videoStream;
    resultArea.innerHTML = "正在扫描二维码...";

    requestAnimationFrame(scanFrame);

  } catch (e) {
    resultArea.innerHTML = "无法访问摄像头：" + e;
    scanning = false;
  }
});

function scanFrame() {
  if (video.readyState !== video.HAVE_ENOUGH_DATA) {
    requestAnimationFrame(scanFrame);
    return;
  }

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

  // jsQR 目前每次只能识别一个二维码，如果需要多码，可以用多次裁切或替代库
  // 这里做简单多次扫描，快速连续扫描即可
  const code = jsQR(imageData.data, imageData.width, imageData.height);

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (code) {
    const keyword = keywordInput.value.trim();
    if (!foundCodes.has(code.data) && (!keyword || code.data.includes(keyword))) {
      foundCodes.add(code.data);
      resultArea.innerHTML += `<br>✅ ${code.data}`;
    }

    // 高亮边框闪烁
    const t = Date.now() / 300;
    ctx.strokeStyle = `rgba(255,0,0,${0.5 + 0.5*Math.sin(t)})`;
    ctx.lineWidth = 4;
    drawLine(code.location.topLeftCorner, code.location.topRightCorner);
    drawLine(code.location.topRightCorner, code.location.bottomRightCorner);
    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner);
    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner);
  }

  requestAnimationFrame(scanFrame);
}

function drawLine(begin, end) {
  ctx.beginPath();
  ctx.moveTo(begin.x, begin.y);
  ctx.lineTo(end.x, end.y);
  ctx.stroke();
}
</script>
</body>
</html>
