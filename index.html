<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>多二维码扫描（iPhone Safari 兼容版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f4f6f9;
    text-align: center;
    padding: 20px;
  }
  h2 { color: #333; }
  #controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
  }
  input {
    padding: 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 220px;
  }
  button {
    background: #007bff;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  #container {
    position: relative;
    display: inline-block;
  }
  #video {
    width: 100%;
    max-width: 600px;
    border-radius: 12px;
    background: #000;
  }
  #overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    max-width: 600px;
    border-radius: 12px;
  }
  #output {
    margin-top: 15px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    display: inline-block;
    text-align: left;
    max-width: 600px;
  }
</style>
</head>
<body>
  <h2>多二维码扫描（高亮闪烁版）</h2>
  <div id="controls">
    <input type="text" id="keyword" placeholder="输入关键字过滤（可选）" />
    <button id="startBtn">Start Scan</button>
  </div>

  <div id="container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="output"><b>识别结果：</b><br><span id="resultArea">暂无</span></div>

  <!-- ZXing 最新模块版 -->
  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from 'https://unpkg.com/@zxing/browser@latest?module';

    const startBtn = document.getElementById('startBtn');
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const resultArea = document.getElementById('resultArea');
    const keywordInput = document.getElementById('keyword');

    let scanning = false;
    let foundCodes = new Set();
    let codeReader;
    let animationFrame;
    let time = 0;

    async function startScan() {
      if (scanning) return;
      scanning = true;
      resultArea.innerText = "正在启动摄像头...";
      foundCodes.clear();

      codeReader = new BrowserMultiFormatReader();

      try {
        // 获取视频输入设备
        const devices = await BrowserMultiFormatReader.listVideoInputDevices();
        if (devices.length === 0) {
          resultArea.innerText = "未找到摄像头";
          scanning = false;
          return;
        }

        const selectedDeviceId = devices[0].deviceId;
        const keyword = keywordInput.value.trim();

        resultArea.innerText = "正在扫描，请将二维码放入摄像头视野中...";

        // 开始扫描视频
        codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err) => {
          if (result) {
            const text = result.getText();
            if (!foundCodes.has(text)) {
              if (!keyword || text.includes(keyword)) {
                foundCodes.add(text);
                resultArea.innerHTML += `<br>✅ ${text}`;
              }
            }
          }
          if (err && !(err instanceof NotFoundException)) {
            console.error(err);
          }
        });

        // 绘制高亮闪烁框
        function animateHighlight() {
          ctx.clearRect(0, 0, overlay.width, overlay.height);
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          time += 0.1;

          const results = codeReader.hints?.results || [];
          if (results && results.length > 0) {
            for (let res of results) {
              if (!res.resultPoints) continue;
              const points = res.resultPoints;
              const isMatch = keyword && res.text && res.text.includes(keyword);
              const color = isMatch
                ? `rgba(255,255,0,${0.5 + 0.5 * Math.sin(time * 4)})`
                : `rgba(0,255,0,${0.3 + 0.3 * Math.sin(time * 3)})`;

              ctx.beginPath();
              ctx.moveTo(points[0].x, points[0].y);
              for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
              }
              ctx.closePath();
              ctx.lineWidth = 4;
              ctx.strokeStyle = color;
              ctx.stroke();
            }
          }
          animationFrame = requestAnimationFrame(animateHighlight);
        }

        animateHighlight();

      } catch (e) {
        console.error(e);
        resultArea.innerText = "无法访问摄像头：" + e;
        scanning = false;
      }
    }

    startBtn.addEventListener('click', startScan);
  </script>
</body>
</html>
