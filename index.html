<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>试剂二维码扫描</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; background: #f0f0f0; }
  #container { position: relative; display: inline-block; margin-top: 10px; }
  video, canvas {
    display: block;
    width: 100%;
    height: auto;
  }
  canvas { position: absolute; top: 0; left: 0; }
  input, button { margin: 5px; font-size: 16px; padding: 5px; }
</style>
</head>
<body>
<h2>试剂二维码扫描</h2>
<input type="text" id="keyword" placeholder="输入试剂编号关键字" />
<button id="startBtn">开始扫描</button>
<div id="container">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="overlay"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const keywordInput = document.getElementById('keyword');

let keyword = '';
let streamStarted = false;
let scanning = false;

// 绘制红框
function drawBoundingBox(code) {
  const scaleX = canvas.clientWidth / canvas.width;
  const scaleY = canvas.clientHeight / canvas.height;

  ctx.strokeStyle = 'red';
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(code.location.topLeftCorner.x * scaleX, code.location.topLeftCorner.y * scaleY);
  ctx.lineTo(code.location.topRightCorner.x * scaleX, code.location.topRightCorner.y * scaleY);
  ctx.lineTo(code.location.bottomRightCorner.x * scaleX, code.location.bottomRightCorner.y * scaleY);
  ctx.lineTo(code.location.bottomLeftCorner.x * scaleX, code.location.bottomLeftCorner.y * scaleY);
  ctx.closePath();
  ctx.stroke();
}

// 显示二维码内容
function drawText(code) {
  const scaleX = canvas.clientWidth / canvas.width;
  const scaleY = canvas.clientHeight / canvas.height;

  ctx.font = "20px sans-serif";
  ctx.fillStyle = 'blue';
  ctx.fillText(code.data, code.location.topLeftCorner.x * scaleX, Math.max(code.location.topLeftCorner.y * scaleY - 5, 20));
}

// 扫描视频帧
function scanFrame() {
  if (!scanning) return;

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    // 清空画布
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (code) {
      drawText(code); // 所有二维码显示内容
      if (keyword && code.data.includes(keyword)) {
        drawBoundingBox(code); // 匹配关键字红框
      }
    }
  }

  setTimeout(scanFrame, 200);
}

// 启动摄像头
async function startCamera() {
  keyword = keywordInput.value.trim();

  if (!streamStarted) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      video.addEventListener('loadedmetadata', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        scanning = true;
        scanFrame();
      });
      streamStarted = true;
    } catch (e) {
      alert('无法访问摄像头，请检查权限');
      return;
    }
  } else {
    scanning = true;
  }
}

// 点击按钮或回车直接启动摄像头扫描
startBtn.addEventListener('click', startCamera);
keywordInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') startCamera();
});
</script>
</body>
</html>
