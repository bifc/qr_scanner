<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>试剂二维码扫描</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; background: #f0f0f0; }
  #container { position: relative; display: inline-block; margin-top: 10px; }
  video { width: 100vw; max-width: 600px; }
  canvas { position: absolute; top: 0; left: 0; }
  input, button { margin: 5px; font-size: 16px; padding: 5px; }
</style>
</head>
<body>
<h2>试剂二维码扫描</h2>
<input type="text" id="keyword" placeholder="输入试剂编号关键字" />
<button id="startBtn">开始扫描</button>
<div id="container">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="overlay"></canvas>
</div>

<!-- jsQR 库 -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const keywordInput = document.getElementById('keyword');

let keyword = '';
let streamStarted = false;
let scanning = false;

// 扫描视频帧
function scanFrame() {
  if (!scanning) return;

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    // 清空之前高亮
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (code) {
      const text = code.data;
      if (keyword && text.includes(keyword)) {
        // 高亮二维码
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(code.location.topLeftCorner.x, code.location.topLeftCorner.y);
        ctx.lineTo(code.location.topRightCorner.x, code.location.topRightCorner.y);
        ctx.lineTo(code.location.bottomRightCorner.x, code.location.bottomRightCorner.y);
        ctx.lineTo(code.location.bottomLeftCorner.x, code.location.bottomLeftCorner.y);
        ctx.closePath();
        ctx.stroke();

        // 显示内容
        ctx.font = "20px sans-serif";
        ctx.fillStyle = 'red';
        ctx.fillText(text, code.location.topLeftCorner.x, Math.max(code.location.topLeftCorner.y - 5, 20));
      }
    }
  }

  setTimeout(scanFrame, 200); // 每200ms扫描一次
}

startBtn.addEventListener('click', async () => {
  keyword = keywordInput.value.trim();
  if (!keyword) { alert('请输入关键字'); keywordInput.focus(); return; }

  if (!streamStarted) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
      video.addEventListener('loadedmetadata', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        scanning = true;
        scanFrame();
      });
      streamStarted = true;
    } catch (e) {
      alert('无法访问摄像头，请检查权限');
      return;
    }
  } else {
    scanning = true;
  }
});

// 支持按回车开始扫描
keywordInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') startBtn.click();
});
</script>
</body>
</html>
